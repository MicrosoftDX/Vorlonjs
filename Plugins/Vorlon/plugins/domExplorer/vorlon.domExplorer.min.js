var __extends=this.__extends||function(e,t){function n(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);n.prototype=t.prototype,e.prototype=new n},VORLON;!function(e){var t=function(t){function n(){t.call(this,"domExplorer","control.html","control.css"),this._internalId=0,this._newAppliedStyles={},this._lastContentState="",this._lastReceivedObject=null,this._clikedNodeID=null,this._spaceCheck=/[^\t\n\r ]/,this._ready=!1}return __extends(n,t),n.prototype.getID=function(){return"DOM"},n.prototype._getAppliedStyles=function(e){for(var t,n=new Array,r=document.styleSheets,i=new Array,o=0;o<r.length;o++){var a=r[o].rules||r[o].cssRules;if(a)for(var l=0;l<a.length;l++){var s=a[l],d=s.selectorText;try{for(var c=document.querySelectorAll(d),h=0;h<c.length;h++){var p=c[h];if(t=s.style,p===e)for(var u=0;u<t.length;u++)-1===i.indexOf(t[u])&&i.push(t[u])}}catch(v){}}}if(t=e.style)for(h=0;h<t.length;h++)-1===i.indexOf(t[h])&&i.push(t[h]);var _=document.defaultView||window;for(h=0;h<i.length;h++){var y=i[h];_.getComputedStyle&&n.push(y+":"+_.getComputedStyle(e,"").getPropertyValue(y))}return n},n.prototype._packageNode=function(t){var n={id:t.id,type:t.nodeType,name:t.localName,classes:t.className,content:t.textContent,attributes:t.attributes?Array.prototype.map.call(t.attributes,function(e){return[e.name,e.value]}):[],styles:this._getAppliedStyles(t),internalId:e.Tools.CreateGUID()};return t.__vorlon?n.internalId=t.__vorlon.internalId:t.__vorlon={internalId:n.internalId},n},n.prototype._packageDOM=function(e,t,n){if(void 0===n&&(n=!1),e.childNodes&&0!==e.childNodes.length)for(var r=0;r<e.childNodes.length;r++){var i=e.childNodes[r],o=this._packageNode(i);n&&this._packageDOM(i,o),i.childNodes&&i.childNodes.length>=0&&(o.hasChildnodes=!0),t.children||(t.children=[]),t.children.push(o)}},n.prototype._packageAndSendDOM=function(e){if(this._internalId=0,this._newAppliedStyles={},e){var t=this._packageNode(e);t.rootHTML=e.innerHTML,this._packageDOM(e,t,!1),t.refreshbyId=!0}else{var t=this._packageNode(document.body);t.rootHTML=document.body.innerHTML,this._packageDOM(document.body,t,!1)}this.sendToDashboard(t)},n.prototype._markForRefresh=function(){this.refresh()},n.prototype.startClientSide=function(){},n.prototype._getElementByInternalId=function(e,t){if(t.__vorlon&&t.__vorlon.internalId===e)return t;if(!t.children)return null;for(var n=0;n<t.children.length;n++){var r=this._getElementByInternalId(e,t.children[n]);if(r)return r}return null},n.prototype.onRealtimeMessageReceivedFromDashboardSide=function(e){if(e.order){var t=this._getElementByInternalId(e.order,document.body);if(t)switch(e.type){case"select":t.__savedOutline=t.style.outline,t.style.outline="2px solid red",this._lastElementSelectedClientSide=t;break;case"unselect":t.style.outline=t.__savedOutline;break;case"ruleEdit":t.style[e.property]=e.newValue}}else switch(e.type){case"unselect":this._lastElementSelectedClientSide&&(this._lastElementSelectedClientSide.style.outline=this._lastElementSelectedClientSide.__savedOutline);break;case"dirtycheck":this.sendToDashboard({action:"dirtycheck",rootHTML:document.body.innerHTML});break;case"refresh":this.refresh(),this._lastContentState=document.body.innerHTML;break;case"refreshbyid":this.refreshbyId(e.internalID),this._lastContentState=document.body.innerHTML}},n.prototype.refresh=function(){this._packageAndSendDOM()},n.prototype.refreshbyId=function(e){e&&this._packageAndSendDOM(this._getElementByInternalId(e,document.body))},n.prototype.startDashboardSide=function(t){var n=this;void 0===t&&(t=null),this._dashboardDiv=t,this._insertHtmlContentAsync(this._dashboardDiv,function(t){n._containerDiv=t,n._treeDiv=e.Tools.QuerySelectorById(t,"treeView"),n._styleView=e.Tools.QuerySelectorById(t,"styleView"),n._refreshButton=n._containerDiv.querySelector('x-action[event="refresh"]'),n._containerDiv.addEventListener("refresh",function(){n.sendToClient({type:"refresh",order:null})}),n._treeDiv.addEventListener("click",function(e){var t=e.target;t.className.match("treeNodeButton")&&(t.hasAttribute("data-collapsed")?t.removeAttribute("data-collapsed"):t.setAttribute("data-collapsed",""))}),n._treeDiv.addEventListener("mouseenter",function(e){var t=e.target,n=t.parentElement,r=t.className.match("treeNodeHeader");(r||n.className.match("treeNodeClosingText"))&&(r?n.setAttribute("data-hovered-tag",""):n.parentElement.parentElement.setAttribute("data-hovered-tag",""))},!0),n._treeDiv.addEventListener("mouseleave",function(e){var t=e.target;if(t.className.match("treeNodeHeader")||t.parentElement.className.match("treeNodeClosingText")){var r=n._treeDiv.querySelector("[data-hovered-tag]");r&&r.removeAttribute("data-hovered-tag")}},!0),$(".dom-explorer-container").split({orientation:"vertical",limit:50,position:"70%"}),n._ready=!0})},n.prototype._makeEditable=function(t){t.contentEditable="true",t.focus(),e.Tools.AddClass(t,"editable");var n=document.createRange();n.setStart(t,0),n.setEnd(t,1),window.getSelection().addRange(n)},n.prototype._generateClickableValue=function(t,n,r){var i=this,o=document.createElement("div");return o.contentEditable="false",o.innerHTML=n||"&nbsp;",o.className="styleValue",o.addEventListener("keydown",function(n){if(13===n.keyCode||9===n.keyCode){var a={};if(a.property=t.innerHTML,a.newValue=o.innerHTML,void 0!==i._newAppliedStyles[r]){for(var l=i._newAppliedStyles[r],s=0;s<l.length;s++){var d=l[s];if(d.property===a.property){d.newValue=a.newValue,a=d,l.splice(s,1);break}}l.push(a)}else{var c=[];c.push(a),i._newAppliedStyles[r]=c}i.sendToClient({type:"ruleEdit",property:t.innerHTML,newValue:o.innerHTML,order:r}),n.preventDefault(),o.contentEditable="false",e.Tools.RemoveClass(o,"editable")}}),o.addEventListener("blur",function(){o.contentEditable="false",e.Tools.RemoveClass(o,"editable")}),o.addEventListener("click",function(){return i._makeEditable(o)}),o},n.prototype._generateStyle=function(t,n,r,i){var o=this;void 0===i&&(i=!1);var a=document.createElement("div");a.className="styleWrap";var l=document.createElement("div");l.innerHTML=t,l.className="styleLabel",l.contentEditable="false";var s=this._generateClickableValue(l,n,r);a.appendChild(l),a.appendChild(s),this._styleView.appendChild(a),i&&(l.addEventListener("blur",function(){l.contentEditable="false",e.Tools.RemoveClass(l,"editable")}),l.addEventListener("click",function(){o._makeEditable(l)}),l.addEventListener("keydown",function(e){(13===e.keyCode||9===e.keyCode)&&(o._makeEditable(s),e.preventDefault())}))},n.prototype._generateStyles=function(e,t){for(var n=this;this._styleView.hasChildNodes();)this._styleView.removeChild(this._styleView.lastChild);for(var r=0;r<e.length;r++){var i=e[r],o=i.split(":");this._generateStyle(o[0],o[1],t)}if(this._newAppliedStyles[t])for(var a=this._newAppliedStyles[t],r=0;r<a.length;r++){var l=a[r];this._generateStyle(l.property,l.newValue,t)}this._generateButton(this._styleView,"+","styleButton").addEventListener("click",function(e){n._generateStyle("property","value",t,!0),n._styleView.appendChild(e.target)})},n.prototype._appendSpan=function(e,t,n){var r=document.createElement("span");r.className=t,r.innerHTML=n,e.appendChild(r)},n.prototype._generateColorfullLink=function(e,t){this._appendSpan(e,"nodeName",t.name),t.attributes.forEach(function(t){var n=document.createElement("span");n.className="nodeAttribute",n.innerHTML="<span>"+t[0]+"</span><span>"+t[1]+"</span>",e.appendChild(n)})},n.prototype._generateColorfullClosingLink=function(e,t){this._appendSpan(e,"nodeName",t.name)},n.prototype._generateButton=function(e,t,n,r){var i=document.createElement("button");return i.innerHTML=t,i.className=n,r&&i.setAttribute(r.name,r.value),i.setAttribute("button-block",""),e.appendChild(i)},n.prototype._generateTreeNode=function(t,n,r){var i=this;if(void 0===r&&(r=!1),3==n.type){if(this._spaceCheck.test(n.content)){var o=document.createElement("span");o.className="nodeTextContent",o.textContent=n.content.trim(),t.appendChild(o)}}else{t.setAttribute("data-has-children","");var a=document.createElement("div");t.appendChild(a);var l=document.createElement("div");l.className="nodeContentContainer";var s=null;n.hasChildnodes&&(s={name:"data-collapsed",value:""},l.id="vorlon-"+n.nodeId),this._generateButton(a,"","treeNodeButton",s).addEventListener("click",function(){n.hasChildnodes&&(i._clikedNodeID=n.internalId,i.sendToClient({type:"refreshbyid",internalID:n.internalId}))});var d=document.createElement("a");if(d.__targetInternalId=n.internalId,this._generateColorfullLink(d,n),d.addEventListener("click",function(){i._previousSelectedNode?(e.Tools.RemoveClass(i._previousSelectedNode,"treeNodeSelected"),i.sendToClient({type:"unselect",order:i._previousSelectedNode.__targetInternalId})):i.sendToClient({type:"unselect",order:null}),e.Tools.AddClass(d,"treeNodeSelected"),i.sendToClient({type:"select",order:n.internalId}),i._generateStyles(n.styles,n.internalId),i._previousSelectedNode=d}),d.href="#",d.className="treeNodeHeader",a.appendChild(d),a.className=r?"firstTreeNodeText":"treeNodeText",n.id){var c=document.createElement("a");c.innerHTML="#",c.className="treeNodeTools",c.href="#",c.addEventListener("click",function(){e.Core.Messenger.sendRealtimeMessage("CONSOLE",{type:"order",order:n.id},e.RuntimeSide.Client,"protocol")}),a.appendChild(c)}var h=n.children;if(h&&h.length)for(var p=0;p<h.length;p++){var u=h[p];3!=u.nodeType&&this._generateTreeNode(l,u)}if(n.name){var v=document.createElement("div");v.className="treeNodeClosingText",this._generateColorfullClosingLink(v,n),l.appendChild(v)}a.appendChild(l)}},n.prototype._insertReceivedObject=function(e,t){if(t.internalId===this._clikedNodeID)return this._clikedNodeID=null,console.log("object inered root",t),console.log("object inered receivedObject",e),t=e,t.hasChildnodes=!1,t;if(t.children&&t.children.length)for(var n=0;n<t.children.length;n++){console.log(n);var r=this._insertReceivedObject(e,t.children[n]);if(r)return t.children[n]=r,t}},n.prototype.onRealtimeMessageReceivedFromClientSide=function(e){if(e.action)switch(e.action){case"dirtycheck":this._lastContentState!=e.rootHTML?this._refreshButton.setAttribute("changed",""):this._refreshButton.removeAttribute("changed")}else if(e.refreshbyId){this._refreshButton.removeAttribute("changed"),console.log("coucou");{this._insertReceivedObject(e,this._lastReceivedObject)}for(console.log("coucou2",this._lastReceivedObject);this._treeDiv.hasChildNodes();)this._treeDiv.removeChild(this._treeDiv.lastChild);this._generateTreeNode(this._treeDiv,this._lastReceivedObject,!0)}else{for(this._refreshButton.removeAttribute("changed"),this._lastContentState=e.rootHTML,this._lastReceivedObject=e;this._treeDiv.hasChildNodes();)this._treeDiv.removeChild(this._treeDiv.lastChild);this._generateTreeNode(this._treeDiv,e,!0)}},n}(e.Plugin);e.DOMExplorer=t,e.Core.RegisterPlugin(new t)}(VORLON||(VORLON={}));